<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Model Deployment (Alpha) · PrimeHub</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Allow users to deploy a model as a service. "/><meta name="docsearch:version" content="2.7"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Model Deployment (Alpha) · PrimeHub"/><meta property="og:type" content="website"/><meta property="og:url" content="https://docs.primehub.io/"/><meta property="og:description" content="Allow users to deploy a model as a service. "/><meta property="og:image" content="https://docs.primehub.io/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://docs.primehub.io/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/img/PrimeHub_icon_32.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/railscasts.min.css"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-123266454-3"></script><script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments); }
              gtag('js', new Date());
              gtag('config', 'UA-123266454-3');
            </script><link rel="stylesheet" href="/css/code-block-buttons.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script><script type="text/javascript" src="/js/code-block-buttons.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/prism.css"/><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/PrimeHub_icon_64.png" alt="PrimeHub"/><h2 class="headerTitleWithLogo">PrimeHub</h2></a><a href="/versions"><h3>2.7</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/getting-started-admin" target="_self">Administrator</a></li><li class=""><a href="/docs/getting-started-user" target="_self">Scientist</a></li><li class="siteNavGroupActive"><a href="/docs/dev-introduction" target="_self">Developer</a></li><li class=""><a href="/docs/index-zh" target="_self">繁中文件</a></li><li class=""><a href="https://medium.com/infuseai" target="_self">Medium</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Designs</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Getting Started<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/dev-introduction">Introduction</a></li><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Setup Kubernetes</h4><ul><li class="navListItem"><a class="navItem" href="/docs/getting_started/prerequisites">Prerequisites</a></li><li class="navListItem"><a class="navItem" href="/docs/getting_started/kubernetes_on_gke">Kubernetes on GKE</a></li><li class="navListItem"><a class="navItem" href="/docs/getting_started/kubernetes_on_eks">Kubernetes on AWS EKS</a></li><li class="navListItem"><a class="navItem" href="/docs/getting_started/kubernetes_on_ubuntu_machine">Kubernetes on an Ubuntu Machine (Single Node)</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Setup PrimeHub</h4><ul><li class="navListItem"><a class="navItem" href="/docs/getting_started/install_metacontroller">Install Metacontroller</a></li><li class="navListItem"><a class="navItem" href="/docs/getting_started/install_keycloak">Install Keycloak</a></li><li class="navListItem"><a class="navItem" href="/docs/getting_started/install_primehub">Install PrimeHub</a></li><li class="navListItem"><a class="navItem" href="/docs/getting_started/install_helper">Install Helper (Advanced)</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Advanced<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/guide_manual/kubeflow-installation-guide">Kubeflow Installation Guide</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Designs and Concepts<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Concepts</h4><ul><li class="navListItem"><a class="navItem" href="/docs/design/architecture">Architecture</a></li><li class="navListItem"><a class="navItem" href="/docs/design/data-model">Data Model</a></li><li class="navListItem"><a class="navItem" href="/docs/design/crds">CRDs</a></li><li class="navListItem"><a class="navItem" href="/docs/design/graphql">GraphqQL</a></li><li class="navListItem"><a class="navItem" href="/docs/design/persistence-storage">Persistence Storages</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Designs</h4><ul><li class="navListItem"><a class="navItem" href="/docs/design/admission">Admission</a></li><li class="navListItem"><a class="navItem" href="/docs/design/jupyterhub">JupyterHub</a></li><li class="navListItem"><a class="navItem" href="/docs/design/notebook-kernel-process">Notebook with kernel process</a></li><li class="navListItem"><a class="navItem" href="/docs/design/dataset-upload">Dataset Upload</a></li><li class="navListItem"><a class="navItem" href="/docs/design/image-builder">Image Builder</a></li><li class="navListItem"><a class="navItem" href="/docs/design/job-submission">Job Submission</a></li><li class="navListItem"><a class="navItem" href="/docs/design/job-scheduler">Job Scheduler</a></li><li class="navListItem"><a class="navItem" href="/docs/design/install-helper-design">Install Helper</a></li><li class="navListItem"><a class="navItem" href="/docs/design/user-portal">User Portal</a></li><li class="navListItem"><a class="navItem" href="/docs/design/meta-chart">Primehub Meta Chart</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/design/model-deployment">Model Deployment (Alpha)</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Tasks<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Build</h4><ul><li class="navListItem"><a class="navItem" href="/docs/tasks/build">Package Builder</a></li><li class="navListItem"><a class="navItem" href="/docs/tasks/airgap">Airgap</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Jupyter Images</h4><ul><li class="navListItem"><a class="navItem" href="/docs/tasks/repo2docker">repo2docker image</a></li><li class="navListItem"><a class="navItem" href="/docs/tasks/non-standard-image">Non standard image</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Registry</h4><ul><li class="navListItem"><a class="navItem" href="/docs/tasks/dockerhub-registry">Use DockerHub Registry</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Operations</h4><ul><li class="navListItem"><a class="navItem" href="/docs/tasks/cluster_shutdown">Cluster Shutdown</a></li><li class="navListItem"><a class="navItem" href="/docs/tasks/benchmark">Benchmark</a></li><li class="navListItem"><a class="navItem" href="/docs/tasks/UPGRADE-K8s-from-1.10-and-1.10-to-1.12">UPGRADE K8s from 1.10 and 1.10 to 1.12</a></li><li class="navListItem"><a class="navItem" href="/docs/tasks/ADVANCED-rook-setup-metadata-on-vg">Setup rook metadata on VG</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">API</h4><ul><li class="navListItem"><a class="navItem" href="/docs/tasks/api-token">Generate API Token</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">References<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/references/primehub_chart">Chart Configuration</a></li><li class="navListItem"><a class="navItem" href="/docs/references/dotenv">Install Helper Environment Variables</a></li><li class="navListItem"><a class="navItem" href="/docs/references/feature-flag">Feature Flags</a></li><li class="navListItem"><a class="navItem" href="/docs/comparison">Features Comparison</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Model Deployment (Alpha)</h1></header><article><div><span><p>Allow users to deploy a model as a service.</p>
<h2><a class="anchor" aria-hidden="true" id="features"></a><a href="#features" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Features</h2>
<ol>
<li><strong>Multiple ML framework support:</strong> Supports Tensorflow 1, Tensorflow 2, Keras, Pytorch, XGBoost, MXNet, Scikit-learn, LightGBM</li>
<li><strong>Multiple language support:</strong> Supports Python, Java, R, NodeJS, Go (Please see the Seldon wrapper in the Seldon wrapper document)</li>
<li><strong>Horizontal scaleout:</strong> The deployed model service can be scaled to multiple replicas of the model service. So that it can achieve load balancing and fault tolerance easily.</li>
<li><strong>Deployment history:</strong> Track the deployment history.</li>
<li><strong>Resource constraint:</strong> The usage of resources for model deployment is constrained by group resource quota.</li>
<li><strong>Ingress:</strong> Create the ingress resource to redirect external requests to internal model service.</li>
</ol>
<h2><a class="anchor" aria-hidden="true" id="user-journey"></a><a href="#user-journey" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>User Journey</h2>
<p>Deploy a model</p>
<ul>
<li>(Admin) Enable a model deployment for one group</li>
<li>Create a deployment. Select the instance type, model image, and the number of replicas.</li>
<li>Wait until the deployment is ready</li>
<li>Use <code>curl</code> to test against the model deployment endpoint</li>
</ul>
<p>Package a model</p>
<ul>
<li>Train a model for some ML framework and select the best model for deployment</li>
<li>Wrap the model file and build the image by <code>s2i</code></li>
<li>Test the packaged image locally</li>
<li>Push the image to docker registry</li>
</ul>
<p>Update a deployment</p>
<ul>
<li>Select a deployment</li>
<li>Click the Update button</li>
<li>Change the image and deploy</li>
</ul>
<h1><a class="anchor" aria-hidden="true" id="configuration"></a><a href="#configuration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configuration</h1>
<p>Please add this variable to the <code>.env</code> file.</p>
<table>
<thead>
<tr><th>Name</th><th>Value</th></tr>
</thead>
<tbody>
<tr><td><code>PRIMEHUB_FEATURE_MODEL_DEPLOYEMNT</code></td><td><code>true</code></td></tr>
</tbody>
</table>
<p>Chart value</p>
<table>
<thead>
<tr><th>Path</th><th>Description</th><th>Default Value</th></tr>
</thead>
<tbody>
<tr><td><code>modelDeployment.enabled</code></td><td>Enable the model deployment</td><td><code>false</code></td></tr>
</tbody>
</table>
<h1><a class="anchor" aria-hidden="true" id="design"></a><a href="#design" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Design</h1>
<h2><a class="anchor" aria-hidden="true" id="seldon"></a><a href="#seldon" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Seldon</h2>
<p><a href="https://www.seldon.io/">Seldon</a> is a model deployment solution in the community. The reason why we select Seldon as the solution is because it provides a common way to package different framework's by different programming languages into a docker image.</p>
<p>Seldon also provides an operator under <code>Seldon core</code> project to manage a <code>SeldonDeployment</code> resource and reconcile it to the underlying deployments and services. However, for simplicity, we decide not to use the <code>SeldonDeployment</code> resource. Instead, we define PhDeployment and the controller for generating/to generate the underlying Deployment and Service directly.</p>
<h2><a class="anchor" aria-hidden="true" id="custom-resource"></a><a href="#custom-resource" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Custom Resource</h2>
<p>A <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">custom resource</a> <code>PhDeployment</code> is defined for PrimeHub-defined model deployment. The deployment is very similar to the Kubernetes native deployment, the controller would spawn a deployment according to the <code>PhDeployment</code>'s spec. The difference is that the spec contains the PrimeHub-specific concept, like User, Group, and InstanceType.</p>
<p>Here is an example of <code>PhDeployment</code>.</p>
<pre><code class="hljs"><span class="hljs-symbol">apiVersion:</span> primehub.io/v1alpha1
<span class="hljs-symbol">kind:</span> PhDeployment
<span class="hljs-symbol">metadata:</span>
<span class="hljs-symbol">  name:</span> spam-classifier-abcxy
<span class="hljs-symbol">  namespace:</span> hub
<span class="hljs-symbol">spec:</span>
<span class="hljs-symbol">  displayName:</span> <span class="hljs-string">"spam classifier"</span>
<span class="hljs-symbol">  userId:</span> <span class="hljs-string">"4d203a08-896a-4aa8-86e2-882f4d4aadec"</span>
<span class="hljs-symbol">  userName:</span> <span class="hljs-string">"phadmin"</span>
<span class="hljs-symbol">  groupId:</span> <span class="hljs-string">"ca6b032e-b8be-44d2-9646-092622d6ba15"</span>
<span class="hljs-symbol">  groupName:</span> <span class="hljs-string">"phusers"</span>  
<span class="hljs-symbol">  stop:</span> false
<span class="hljs-symbol">  description:</span> |
    This is my first deployment.
    This is my first deployment.
    This is my first deployment.
<span class="hljs-symbol">  predictors:</span>
    - name: predictor1
<span class="hljs-symbol">      replicas:</span> <span class="hljs-number">2</span>
<span class="hljs-symbol">      modelImage:</span> sandhya1594/spam-classifier:<span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
<span class="hljs-symbol">      instanceType:</span> cpu-only
<span class="hljs-symbol">      metadata:</span>
<span class="hljs-symbol">        LEARNING_RATE:</span> <span class="hljs-string">"0.02"</span>
<span class="hljs-symbol">        MINI_BATCH:</span> <span class="hljs-string">"20"</span>
<span class="hljs-symbol">        ACCURACY:</span> <span class="hljs-string">"0.98"</span>
<span class="hljs-symbol">status:</span>
<span class="hljs-symbol">  phase:</span> deploying
<span class="hljs-symbol">  message:</span> <span class="hljs-string">"Deploying"</span>
<span class="hljs-symbol">  replicas:</span> <span class="hljs-number">2</span>
<span class="hljs-symbol">  availableReplicas:</span> <span class="hljs-number">2</span>
<span class="hljs-symbol">  endpoint:</span> https:<span class="hljs-comment">//primehub.local/deployment/user-defined-postfix/predict</span>
<span class="hljs-symbol">  history:</span>
    - time: <span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-23</span>T02:<span class="hljs-number">03</span>:<span class="hljs-number">15</span>Z
<span class="hljs-symbol">      spec:</span> <span class="hljs-params">&lt;PhDeploymentSpec&gt;</span>
    - time: <span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-22</span>T23:<span class="hljs-number">45</span>:<span class="hljs-number">23</span>Z
<span class="hljs-symbol">      spec:</span> <span class="hljs-params">&lt;PhDeploymentSpec&gt;</span>
</code></pre>
<p>The <code>PhDeployment</code> resource has the following children</p>
<ul>
<li><strong>Ingress:</strong> The ingress resource to route the traffic to given model deployment</li>
<li><strong>Service:</strong> The service resource of a given deployment</li>
<li><strong>Deployment:</strong> The deployment of the user's image.</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="model-image"></a><a href="#model-image" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Model Image</h2>
<p>For each deployment, it requires to provide the model image. It is responsible to translate the REST request to the internal model prediction call.</p>
<p>In <a href="https://docs.seldon.io/projects/seldon-core/en/latest/index.html">Seldon documentation</a>, there are two ways to prepare the model image</p>
<p>Pre-Packaged Inference Servers</p>
<ul>
<li>MLflow Server</li>
<li>SKLearn server</li>
<li>Tensorflow Serving</li>
<li>XGBoost server</li>
</ul>
<p>Language Wrappers</p>
<ul>
<li>Python Language Wrapper (Production)</li>
<li>Java Language Wrapper (Incubating)</li>
<li>R Language Wrapper (ALPHA)</li>
<li>NodeJS Language Wrapper (ALPHA)</li>
<li>Go Language Wrapper (ALPHA)</li>
</ul>
<p>Currently, primehub model deployment ONLY supports the language wrapper solution. In the future, we may provide a guideline to write a Dockerfile to pack the model file in the pre-packaged server image.</p>
<h2><a class="anchor" aria-hidden="true" id="api-endpoint"></a><a href="#api-endpoint" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>API Endpoint</h2>
<p>According to Seldon <a href="https://docs.seldon.io/projects/seldon-core/en/latest/reference/apis/external-prediction.html">external prediction</a> and <a href="https://docs.seldon.io/projects/seldon-core/en/latest/reference/apis/internal-api.html">internal microservice</a> API, the endpoint of prediction is</p>
<pre><code class="hljs"><span class="hljs-params">&lt;prefix&gt;</span><span class="hljs-meta-keyword">/api/</span>v0<span class="hljs-number">.1</span>/predictions
<span class="hljs-meta"># or</span>
<span class="hljs-params">&lt;prefix&gt;</span><span class="hljs-meta-keyword">/api/</span>v1<span class="hljs-number">.0</span>/predictions
</code></pre>
<p>For a primehub model deployment, the prefix would be</p>
<pre><code class="hljs"><span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/&lt;primehub-domain&gt;/deployment</span><span class="hljs-regexp">/&lt;deployment-name&gt;/api</span><span class="hljs-regexp">/v1.0/predictions</span>
</code></pre>
<p>And the input and output of the prediction endpoint are <em>tensor</em> or <em>ndarray</em>.</p>
<p>You can also send an unstructured data (e.g. image file), please find more examples in our <a href="https://github.com/InfuseAI/model-deployment-examples">model deployment examples</a></p>
<h2><a class="anchor" aria-hidden="true" id="deployment-phases"></a><a href="#deployment-phases" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deployment Phases</h2>
<p>There are 5 phases in the <code>PhDeployment</code></p>
<ul>
<li><strong>Deploying:</strong> Model is deploying. When a deployment is created, updated, or started, it will go to this phase immediately.</li>
<li><strong>Deployed:</strong> Model is deployed successfully. All replicas are in available state.</li>
<li><strong>Stopping:</strong> The deployment is stopping. When a deployment is stopped, it will go to this phase immediately.</li>
<li><strong>Stopped:</strong> The deployment is stopped successfully.</li>
<li><strong>Failed:</strong> The model deployment is failed.</li>
</ul>
<p>There are several reasons for the <code>Failed</code> phase. They include</p>
<ul>
<li>Group, or instance type not found</li>
<li>Image invalid or cannot be pulled successfully</li>
<li>Group resource not enough</li>
<li>Cluster resource not enough</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="resource-constraint"></a><a href="#resource-constraint" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Resource Constraint</h2>
<p>A model deployment consumes only group quota.</p>
<p>The pod of the model deployment has the label <code>primehub.io/group=escape(&lt;group&gt;)</code>. The PrimeHub's validating webhook would invalidate the pod creation if the new pod exceeds the group resource.</p>
<p>Once the resource exceeds, the deployment would change to phase <code>Failed</code> with &quot;group resource not enough&quot; error message.</p>
<h2><a class="anchor" aria-hidden="true" id="replicas-log"></a><a href="#replicas-log" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Replicas Log</h2>
<p>The pod of the model deployment has the labels</p>
<ul>
<li><code>app=primehub-group</code></li>
<li><code>primehub.io/phdeployment=&lt;deployment-id&gt;</code></li>
</ul>
<p>The GraphQL server would list the pod by these labels and show the log for the container name <code>model</code></p>
<h2><a class="anchor" aria-hidden="true" id="deployment-history"></a><a href="#deployment-history" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deployment History</h2>
<p>Whenever the <code>.spec</code> changes, there appends a new record under <code>.status.history</code>. It contains <code>time</code> for update time and <code>spec</code> for the snapshot of the current new updated <code>.spec</code>.</p>
<p>The history array only keeps the latest 32 records.</p>
<h2><a class="anchor" aria-hidden="true" id="monitoring"></a><a href="#monitoring" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Monitoring</h2>
<p>We use <a href="https://github.com/SeldonIO/seldon-core/tree/master/engine">Seldon engine</a> to export Prometheus metrics. Under the hood, it accepts the prediction request and forwards it to the user wrapped model container. At the same time, it keeps track of the count and time for each request. The metrics details are described in <a href="https://docs.seldon.io/projects/seldon-core/en/latest/analytics/analytics.html">Seldon metrics</a></p>
<p>Seldon has a project name <a href="https://github.com/SeldonIO/seldon-core/tree/master/helm-charts/seldon-core-analytics">Seldon analytics</a>. In which, it installs the Prometheus and Grafana. However, our preferred Prometheus/Grafana installation is <a href="https://github.com/coreos/prometheus-operator">prometheus-operator</a>. To adapt the metrics to Prometheus-operator, we implement our own <a href="https://github.com/coreos/prometheus-operator#customresourcedefinitions">PodMonitoring</a> and Grafana dashboard to visualize the collected metrics.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/design/meta-chart"><span class="arrow-prev">← </span><span>Meta Chart</span></a><a class="docs-next button" href="/docs/tasks/build"><span>Package Builder</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#features">Features</a></li><li><a href="#user-journey">User Journey</a></li><li><a href="#seldon">Seldon</a></li><li><a href="#custom-resource">Custom Resource</a></li><li><a href="#model-image">Model Image</a></li><li><a href="#api-endpoint">API Endpoint</a></li><li><a href="#deployment-phases">Deployment Phases</a></li><li><a href="#resource-constraint">Resource Constraint</a></li><li><a href="#replicas-log">Replicas Log</a></li><li><a href="#deployment-history">Deployment History</a></li><li><a href="#monitoring">Monitoring</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/PrimeHub_icon_128.png" alt="PrimeHub" width="66" height="58"/></a><div><h5>Community</h5><a href="https://github.com/InfuseAI/primehub">PrimeHub CE</a><a href="https://github.com/infuseai">InfuseAI x GitHub</a><a href="https://medium.com/infuseai">InfuseAI x Medium</a></div><div><h5>More</h5><a href="https://infuseai.io">About InfuseAI</a><a href="/docs/next/comparison">Community | Enterprise</a></div></section><section class="copyright">Copyright © 2020 InfuseAI</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'f482b898949e00de71a14ed19cc167ce',
                indexName: 'infuseai_primehub',
                inputSelector: '#search_input_react',
                algoliaOptions: {"hitsPerPage":10}
              });
            </script></body></html>