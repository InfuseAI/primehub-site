<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Job Submission ¬∑ PrimeHub</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Allow users to submit machine learning training jobs to the cluster"/><meta name="docsearch:version" content="2.8"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Job Submission ¬∑ PrimeHub"/><meta property="og:type" content="website"/><meta property="og:url" content="https://docs.primehub.io/"/><meta property="og:description" content="Allow users to submit machine learning training jobs to the cluster"/><meta property="og:image" content="https://docs.primehub.io/img/primehub_icon.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://docs.primehub.io/img/primehub_icon.svg"/><link rel="shortcut icon" href="/img/PrimeHub_icon_32.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/railscasts.min.css"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-123266454-3"></script><script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments); }
              gtag('js', new Date());
              gtag('config', 'UA-123266454-3');
            </script><link rel="stylesheet" href="/css/code-block-buttons.css"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Oswald|Lato:400,400i,700"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script><script type="text/javascript" src="/js/code-block-buttons.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/prism.css"/><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/PrimeHub_icon_64.png" alt="PrimeHub"/><h2 class="headerTitleWithLogo">PrimeHub</h2></a><a href="/versions"><h3>2.8</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/2.8/introduction" target="_self">Documentation</a></li><li class=""><a href="/docs/2.8/index-zh" target="_self">ÁπÅ‰∏≠Êñá‰ª∂</a></li><li class=""><a href="https://one.primehub.io/" target="_blank">üåü 1-Click Install ‚áó</a></li><li class=""><a href="https://cse.google.com/cse?cx=a1b608e4a3908f544" target="_blank">Search ‚áó</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Job Submission</h1></header><article><div><span><p>Allow users to submit machine learning training jobs to the cluster</p>
<h1><a class="anchor" aria-hidden="true" id="features"></a><a href="#features" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Features</h1>
<ol>
<li><strong>Job Queue:</strong> Job is processed by the order of a queue. And one group has one queue.</li>
<li><strong>Image and InstanceType:</strong> Just like jupyter noteobook, a user can select the preset images and instance types according to the current selected group</li>
<li><strong>Shared Volume:</strong> The job's running pod would mount the shared volume according to the selected group.</li>
<li><strong>Cancellation:</strong> Allow to cancel a pending or running pode</li>
<li><strong>POD Time-To-Live:</strong> Allow to clean up the pod after a job is finished for a period of time.</li>
</ol>
<h1><a class="anchor" aria-hidden="true" id="configuration"></a><a href="#configuration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configuration</h1>
<p>Please add this variable to the <code>.env</code> file.</p>
<table>
<thead>
<tr><th>Name</th><th>Value</th></tr>
</thead>
<tbody>
<tr><td><code>PRIMEHUB_FEATURE_JOB_SUBMISSION</code></td><td><code>true</code></td></tr>
</tbody>
</table>
<p>Chart value</p>
<table>
<thead>
<tr><th>Path</th><th>Description</th><th>Default Value</th></tr>
</thead>
<tbody>
<tr><td><code>jobSubmission.workingDirSize</code></td><td>The size of ephemeral storage for working directory. The format of unit is defined in <a href="https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/">kubernetes document</a></td><td><code>5Gi</code></td></tr>
<tr><td><code>jobSubmission.defaultActiveDeadlineSeconds</code></td><td>Default timeout (seconds) for a running job</td><td><code>86400</code></td></tr>
<tr><td><code>jobSubmission.defaultTTLSecondsAfterFinished</code></td><td>Default TTL (seconds) to delete the pod for a finished job</td><td><code>604800</code></td></tr>
<tr><td><code>jobSubmission.nodeSelector</code></td><td>The default <a href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector">node selector</a> for the underlying pod</td><td><code>{}</code></td></tr>
<tr><td><code>jobSubmission.affinity</code></td><td>The default <a href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity">affinity</a> setting for the underlying pod</td><td><code>{}</code></td></tr>
<tr><td><code>jobSubmission.tolerations</code></td><td>The default <a href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/">tolerations</a> setting for the underlying pod</td><td><code>[]</code></td></tr>
</tbody>
</table>
<h2><a class="anchor" aria-hidden="true" id="memory-setting"></a><a href="#memory-setting" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Memory Setting</h2>
<p>Job submission controller uses 512Mb memory at most by default. Under this setting, it can record around 50 thousand job history. Please delete some old <code>phjob</code> records if you found <code>phjob</code> records are near 50 thousand. Otherwise, it will run out of memory and cannot work appropriately.</p>
<p>If you want to record more job history, please increase/add the memory setting in <code>helm_override/primehub.yaml</code>, for example:</p>
<pre><code class="hljs"><span class="hljs-symbol">controller:</span>
<span class="hljs-symbol">  resources:</span>
<span class="hljs-symbol">    limits:</span>
<span class="hljs-symbol">      memory:</span> <span class="hljs-number">5</span>Gi
</code></pre>
<h1><a class="anchor" aria-hidden="true" id="design"></a><a href="#design" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Design</h1>
<h2><a class="anchor" aria-hidden="true" id="custom-resource"></a><a href="#custom-resource" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Custom Resource</h2>
<p>A <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">custom resource</a> <code>PhJob</code> is defined for PrimeHub-defined job. The job is very similar to the kubernetes native job, the controller would spawn a pod for the job's spec. The difference is that the spec contains the PrimeHub-specific concept, like group, image, instance type.</p>
<p>Here is an example of <code>PhJob</code>.</p>
<pre><code class="hljs"><span class="hljs-symbol">apiVersion:</span> primehub.io/v1alpha1
<span class="hljs-symbol">kind:</span> PhJob
<span class="hljs-symbol">metadata:</span>
<span class="hljs-symbol">  name:</span> job-qm42d
<span class="hljs-symbol">  namespace:</span> hub
<span class="hljs-symbol">spec:</span>
<span class="hljs-symbol">  command:</span> |
    echo <span class="hljs-string">"start"</span>
<span class="hljs-symbol">  displayName:</span> Test Job
<span class="hljs-symbol">  userId:</span> <span class="hljs-number">619156f</span>e<span class="hljs-number">-43</span>c6<span class="hljs-number">-44</span>f3-b20e<span class="hljs-number">-2</span>d5f96e4df96
<span class="hljs-symbol">  userName:</span> jackpan  
<span class="hljs-symbol">  groupId:</span> d8257cb0<span class="hljs-number">-3</span>c89<span class="hljs-number">-4243</span><span class="hljs-number">-98</span>c2-cdc737ec61d3
<span class="hljs-symbol">  groupName:</span> test-job-submission
<span class="hljs-symbol">  image:</span> base-notebook
<span class="hljs-symbol">  instanceType:</span> cpu-tiny
<span class="hljs-symbol">status:</span>
<span class="hljs-symbol">  phase:</span> pending
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="state-diagram"></a><a href="#state-diagram" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>State Diagram</h2>
<p><img src="/docs/assets/job-submission-state-diagram.png" alt=""></p>
<p>There are 6 states for the <code>PhJob</code></p>
<ul>
<li><strong>Pending:</strong> Job is pending in queue</li>
<li><strong>Preparing:</strong> The job is dequeue and ready to be processed. The underlying pod is created and waiting for scheduled and initiated.</li>
<li><strong>Running:</strong> Pod is running</li>
<li><strong>Failed:</strong> Pod is failed.</li>
<li><strong>Succeeded:</strong> Pod is terminated successfully.</li>
<li><strong>Cancelled:</strong> The job is Canceled</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="scheduler"></a><a href="#scheduler" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Scheduler</h2>
<p>Unlike kubernetes' job, <code>PhJob</code> is scheduled by the controller rather than scheduler. And only when the resource is ready is the pod created. Here is the basic principle for scheduling</p>
<ul>
<li><strong>Group is a logical queue.</strong> Jobs in the same group is scheduled in the FIFO (first in first out) manner</li>
<li><strong>Resource constraint:</strong> Job is scheduled only when it doesn't hit the group quota and user quota. And  if a job has no enough resource in user quota, it will not block other jobs belong to other users.</li>
<li><strong>Resource Pool:</strong> Both the jupyter server and job share the same resource pool.</li>
<li><strong>Pod creation:</strong> pod is created as the job is scheduled.</li>
<li><strong>State change:</strong> once a job is scheduled, the state is changed from <code>pending</code> to <code>preparing</code></li>
</ul>
<p>Here are some examples for the scheduling behavior.</p>
<p><strong>Example 1</strong></p>
<p>There are three job submitted to the same group <code>phusers</code>. Assume that the group setting is</p>
<ul>
<li><strong>User quota:</strong> 4 gpu</li>
<li><strong>Group quota:</strong> 4 gpu</li>
</ul>
<p>And the job specs are</p>
<table>
<thead>
<tr><th>Job</th><th>Gpu Request</th><th>User</th></tr>
</thead>
<tbody>
<tr><td>A</td><td>2</td><td>bob</td></tr>
<tr><td>B</td><td>4</td><td>pan</td></tr>
<tr><td>C</td><td>2</td><td>lin</td></tr>
</tbody>
</table>
<p>Results</p>
<table>
<thead>
<tr><th>Job</th><th>Gpu Request</th><th>User</th><th>Result</th></tr>
</thead>
<tbody>
<tr><td>A</td><td>2</td><td>bob</td><td>Preparing</td></tr>
<tr><td>B</td><td>4</td><td>pan</td><td>Pending</td></tr>
<tr><td>C</td><td>2</td><td>lin</td><td>Pending</td></tr>
</tbody>
</table>
<p>The job B is blocked because no enough of gpu. The job C is blocked by job B because job is scheduled by FIFO.</p>
<p><strong>Example 2</strong></p>
<p>The same as example 1, there are three job submitted to the same group <code>phusers</code>. And the group setting is also</p>
<ul>
<li><strong>User quota:</strong> 4 gpu</li>
<li><strong>Group quota:</strong> 4 gpu</li>
</ul>
<p>The job specs are</p>
<table>
<thead>
<tr><th>Job</th><th>Gpu Request</th><th>User</th></tr>
</thead>
<tbody>
<tr><td>A</td><td>2</td><td>bob</td></tr>
<tr><td>B</td><td>4</td><td><strong>bob</strong></td></tr>
<tr><td>C</td><td>2</td><td>lin</td></tr>
</tbody>
</table>
<p>The only difference is the job B is also submitted by bob. The result is</p>
<table>
<thead>
<tr><th>Job</th><th>Gpu Request</th><th>User</th><th>Result</th></tr>
</thead>
<tbody>
<tr><td>A</td><td>2</td><td>bob</td><td>Preparing</td></tr>
<tr><td>B</td><td>4</td><td>bob</td><td>Pending</td></tr>
<tr><td>C</td><td>2</td><td>lin</td><td>Preparing</td></tr>
</tbody>
</table>
<p>The job B is block because no enough of gpu. The job C is scheduled because job B is blocked by user quota rather than group quota. If user quota is not enough, the job is not eligible to block other job belong to other users.</p>
<h3><a class="anchor" aria-hidden="true" id="requeue"></a><a href="#requeue" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Requeue</h3>
<p>After a job is scheduled, the underlying pod is created. However, according to the <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/">pod lifecycle design</a>, a pod does not run immediately until the job is assigned to a node and the containers are initiated. If a pod cannot reach to running state for a given time (default 3 minutes), the job is pushed back from <strong>preparing</strong> state to <strong>pending</strong> state and wait for next scheduling.</p>
<h2><a class="anchor" aria-hidden="true" id="running-pod"></a><a href="#running-pod" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Running Pod</h2>
<p>Here describe what the underlying pod would look like. The pod is generated according to the selected group, image, and instance type. It determine what image to use, how many resource to request, and how many volumes should be mounted.</p>
<h3><a class="anchor" aria-hidden="true" id="folder-structure"></a><a href="#folder-structure" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Folder Structure</h3>
<p>The primary volumes and locations are</p>
<table>
<thead>
<tr><th>Type</th><th>Path</th><th>Note</th></tr>
</thead>
<tbody>
<tr><td>Working Directory</td><td><code>/workingdir</code></td><td>Is mounted as <code>emptyDir</code></td></tr>
<tr><td>Datasets</td><td><code>/datasets/&lt;dataset-name&gt;</code></td><td>symlink to <code>/workingdir/datasets</code></td></tr>
<tr><td>Group Volume</td><td><code>/project/&lt;dataset-name&gt;</code></td><td>symlink to <code>/workingdir/project</code></td></tr>
<tr><td>User Volume</td><td>N/A</td></tr>
</tbody>
</table>
<pre><code class="hljs">‚îú‚îÄ‚îÄ datasets
‚îÇ   ‚îú‚îÄ‚îÄ ds1
‚îÇ   ‚îú‚îÄ‚îÄ ds2
‚îÇ   ‚îî‚îÄ‚îÄ ds3
‚îú‚îÄ‚îÄ project
‚îÇ   ‚îú‚îÄ‚îÄ group1
‚îÇ   ‚îú‚îÄ‚îÄ group2
‚îÇ   ‚îî‚îÄ‚îÄ group3
‚îî‚îÄ‚îÄ workingdir
    ‚îú‚îÄ‚îÄ datasets -&gt; /datasets
    ‚îÇ   ‚îú‚îÄ‚îÄ ds1
    ‚îÇ   ‚îú‚îÄ‚îÄ ds2
    ‚îÇ   ‚îî‚îÄ‚îÄ ds3
    ‚îú‚îÄ‚îÄ group1 -&gt; /project/group1
    ‚îú‚îÄ‚îÄ group2 -&gt; /project/group2
    ‚îî‚îÄ‚îÄ group3 -&gt; /project/group3
</code></pre>
<p>The working directory is mounted as a <code>emptyDir</code> so that users can put temporary data under the folder.</p>
<h3><a class="anchor" aria-hidden="true" id="compare-to-jupyter-pod"></a><a href="#compare-to-jupyter-pod" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compare to Jupyter Pod</h3>
<table>
<thead>
<tr><th>Feature</th><th>Jupyter</th><th>Job</th></tr>
</thead>
<tbody>
<tr><td>user volume</td><td>Yes</td><td>No</td></tr>
<tr><td>group Volume</td><td>Yes</td><td>Yes</td></tr>
<tr><td>pv dataset</td><td>Yes</td><td>Yes</td></tr>
<tr><td>pv dataset (hostpath)</td><td>Yes</td><td>No</td></tr>
<tr><td>env dataset</td><td>Yes</td><td>Yes</td></tr>
<tr><td>git dataset</td><td>Yes</td><td>Yes</td></tr>
<tr><td>working directory</td><td>/home/jovyan (user volume)</td><td>/workingdir (emptyDir)</td></tr>
<tr><td>start-notebook script</td><td>Yes</td><td>No</td></tr>
</tbody>
</table>
<h3><a class="anchor" aria-hidden="true" id="log"></a><a href="#log" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Log</h3>
<p>The job log is not stored externally. Instead, the log is retrieve by the underlying pod. So to retrieve the log, just</p>
<pre><code class="hljs">kubectl -n hub log job<span class="hljs-number">-20200101</span><span class="hljs-number">-12345</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="environment-variables"></a><a href="#environment-variables" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Environment Variables</h3>
<p>There are these environment variables defined in the running jobs.</p>
<table>
<thead>
<tr><th>Key</th><th>Value</th></tr>
</thead>
<tbody>
<tr><td><code>PRIMEHUB_USER</code></td><td>The user to submit the job</td></tr>
<tr><td><code>PRIMEHUB_GROUP</code></td><td>The launch group of the job</td></tr>
</tbody>
</table>
<h3><a class="anchor" aria-hidden="true" id="timeout"></a><a href="#timeout" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Timeout</h3>
<p>To prevent the job from running too long time, there is a default timeout 1 day. The timeout can be configured by</p>
<ul>
<li>Overwrite <code>PhJob</code> spec <code>.spec.activeDeadlineSeconds</code></li>
<li>Overwrite the helm value <code>jobSubmission.defaultActiveDeadlineSeconds</code></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="cancellation"></a><a href="#cancellation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cancellation</h2>
<p>A job can be cancelled in non-final state. To cancel a job, just set the PhJob <code>.spec.cancel</code> to <code>true</code>. If a job is cancelled, the underlying pod is deleted.</p>
<h2><a class="anchor" aria-hidden="true" id="pod-ttl-after-finished"></a><a href="#pod-ttl-after-finished" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Pod TTL After Finished</h2>
<p>Pod is a heavy resource for these two reasons</p>
<ul>
<li>Log</li>
<li>Overlay storage</li>
</ul>
<p>Even though the container is terminated, these two resources are not released until the pod is deleted.</p>
<p>To make operator easier to reclaim the resources, we can configure the TTL of Pods. The default value is 7 days. This can also be configured by</p>
<ul>
<li>Overwrite PhJobs spec <code>.spec.ttlSecondsAfterFinished</code></li>
<li>Overwrite the helm value <code>jobSubmission.defaultTTLSecondsAfterFinished</code></li>
</ul>
<h1><a class="anchor" aria-hidden="true" id="administrator"></a><a href="#administrator" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Administrator</h1>
<h2><a class="anchor" aria-hidden="true" id="working-directory-size"></a><a href="#working-directory-size" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Working Directory Size</h2>
<p>The working directory is mounted to a <a href="https://kubernetes.io/docs/concepts/storage/volumes/#emptydir">emptyDir</a> volume. By default, the capacity is 5Gb. The default value can be changed by the helm value<code>.jobSubmission.workingDirSize</code></p>
<h2><a class="anchor" aria-hidden="true" id="default-pod-scheduling"></a><a href="#default-pod-scheduling" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Default Pod Scheduling</h2>
<p>It is desired to limit the job only run on specific node. We can configure the default <code>nodeSelector</code>, <code>affinity</code>, <code>tolerations</code> for created pod.</p>
<h2><a class="anchor" aria-hidden="true" id="performance-issues"></a><a href="#performance-issues" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Performance Issues</h2>
<p>It is a known issue that there might be some performance issues when <code>phjob</code> has more than 10 thousand records. For example, job submission page or jupyter spawner page takes longer time to response. If you notice this situation, please try to delete old <code>phjob</code> records and see if it alleviates the situation.</p>
<h1><a class="anchor" aria-hidden="true" id="faq"></a><a href="#faq" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FAQ</h1>
<p><strong>Q: Can one group run more than one jobs at the same time?</strong></p>
<p>Yes. If the job have not reached the user quota and group quota</p>
<p><strong>Q: Why jobs are not run in the right order?</strong></p>
<p>The lifecycle of a job is from <code>pending</code>, to <code>preparing</code>, then <code>running</code>. We only guarantee that jobs enter the <code>preparing</code> state in the order of the job creation time. After a job is preparing, we cannot guarantee that the job goes to the <code>running</code> state in the same order. For example, one job takes longer time to pull an image than another one does.</p>
<p><strong>Q: Why are all my jobs stuck in the preparing state?</strong></p>
<p>This is because the pod cannot be initiated for some reason. Please ask the operator to see what happens to the underlying pod. One common reason is the cluster has no enough resources for this pod.</p>
<p><strong>Q: Does a job enter preparing state only when the cluster has enough resources?</strong></p>
<p>No. The only criteria if a job enters the <code>preparing</code> state are if there are enough user and group quota. That is, it is still possible that the pod cannot be scheduled because no node can fit the submitted job.</p>
<p>The administrator should plan the instance type, user quota, group quota carefully to prevent resource over-commit happens.</p>
<p><strong>Q: Can I kill a job?</strong></p>
<p>Yes. But currently, we only allow users to delete a job from <code>kubectl</code>. The command is</p>
<pre><code class="hljs">kubectl -n hub <span class="hljs-keyword">delete</span> phjob &lt;job <span class="hljs-type">name</span>&gt;
</code></pre>
<p>As the phjob is deleted, the underlying pod is deleted as well.</p>
<p><strong>Q: Why can't I see the log?</strong></p>
<p>From the UI, the log is retrieved in the same way of <code>kubectl -n hub logs &lt;podname&gt;</code>. So if you cannot see the log, the reason could be</p>
<ol>
<li>The underlying pod is not created or deleted</li>
<li>The log of the pod is deleted, truncated, or rotated for docker daemon.</li>
</ol>
<p>If a job is canceled or timeout, the log cannot be retrieved because the underlying pod is deleted. This is the current limitation and we hope we can preserve the log in the future.</p>
<p><strong>Q: What happens if my job runs on a lost node?</strong></p>
<p>If a pod is running on a lost node (which shows <code>NotReady</code> status on the <code>kubectl get nodes</code>), the pod status will change to <code>Unknown</code> status in 5 minutes. At this moment, the job is still in the <code>Running</code> state. However, the job detail pages may show the following message and the log cannot show correctly.</p>
<pre><code class="hljs">Status:    Running
Message:   Node &lt;node-<span class="hljs-built_in">name</span>&gt; which was <span class="hljs-built_in">running</span> pod &lt;job-<span class="hljs-built_in">id</span>&gt; <span class="hljs-keyword">is</span> unresponsive
</code></pre>
<p>It should be noted that the resources for this job are not released.</p>
<p>What we can do is</p>
<ol>
<li>Just cancel the job, then the job resources will be released. And re-run the job if necessary.</li>
<li>Ask operators to recover the lost node. Once the node is recovered, the pod can still run.</li>
</ol>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#memory-setting">Memory Setting</a></li><li><a href="#custom-resource">Custom Resource</a></li><li><a href="#state-diagram">State Diagram</a></li><li><a href="#scheduler">Scheduler</a><ul class="toc-headings"><li><a href="#requeue">Requeue</a></li></ul></li><li><a href="#running-pod">Running Pod</a><ul class="toc-headings"><li><a href="#folder-structure">Folder Structure</a></li><li><a href="#compare-to-jupyter-pod">Compare to Jupyter Pod</a></li><li><a href="#log">Log</a></li><li><a href="#environment-variables">Environment Variables</a></li><li><a href="#timeout">Timeout</a></li></ul></li><li><a href="#cancellation">Cancellation</a></li><li><a href="#pod-ttl-after-finished">Pod TTL After Finished</a></li><li><a href="#working-directory-size">Working Directory Size</a></li><li><a href="#default-pod-scheduling">Default Pod Scheduling</a></li><li><a href="#performance-issues">Performance Issues</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/PrimeHub_icon_128.png" alt="PrimeHub" width="66" height="58"/></a><div><h5></h5><a href="https://discord.gg/CrAxQznedH">Discord</a><a href="https://github.com/infuseai">GitHub</a><a href="https://medium.com/infuseai">Medium</a><a href="https://www.facebook.com/InfuseAI">Facebook</a><a href="https://www.katacoda.com/infuseai">Katacoda</a></div><div><h5>More</h5><a href="https://infuseai.io">About InfuseAI</a><a href="/docs/comparison">Community | Enterprise | Deploy</a><a href="https://docs.google.com/forms/d/e/1FAIpQLSe_Z8JfIbYnvhOampGN_XXle4d3GVX04E8evnNI_Py3abth-A/viewform">Request Trial</a></div></section><section class="copyright">Copyright ¬© 2021 InfuseAI</section></footer></div></body></html>